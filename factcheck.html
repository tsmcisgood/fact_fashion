import React, { useState, useRef } from 'react';
import { Camera, Upload, RefreshCcw, Zap, Shirt, Scissors, AlertTriangle } from 'lucide-react';

const FashionRoaster = () => {
  const [image, setImage] = useState(null);
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState(null);
  const [error, setError] = useState(null);
  const fileInputRef = useRef(null);

  // Gemini API Configuration
  const apiKey = ""; // Runtime environment provides this automatically

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setImage(reader.result);
        setResult(null);
        setError(null);
      };
      reader.readAsDataURL(file);
    }
  };

  const triggerUpload = () => {
    fileInputRef.current.click();
  };

  const analyzeFashion = async () => {
    if (!image) return;
    setLoading(true);
    setError(null);

    try {
      // Prepare Base64 data (remove header)
      const base64Data = image.split(',')[1];

      const systemPrompt = `
        너는 청담동에서 20년 일한, 눈 높고 독설로 유명한 톱 스타일리스트야. 
        사용자가 올린 남자 옷 사진을 보고 다음 형식의 JSON 데이터를 반환해. 마크다운 태그 없이 순수 JSON만 반환해.
        
        말투 가이드:
        - 아주 신랄하고 재수없게, 하지만 정확하게 뼈를 때려야 해 (Umax 스타일).
        - 반말을 사용하고, "자기야", "이봐" 같은 호칭을 써.
        - 핏, 색조합, 유행 지난 아이템을 집요하게 물고 늘어져.
        
        JSON 구조 (반드시 이 구조를 준수해):
        {
          "score": 0~100 사이의 숫자 (정수),
          "roast": "전체적인 총평 (문자열)",
          "analysis": {
            "fit": "핏 평가 (문자열)",
            "color": "색감 평가 (문자열)",
            "trend": "유행 평가 (문자열)"
          },
          "recommendation": ["추천아이템1(문자열)", "추천아이템2(문자열)", "추천아이템3(문자열)"]
        }
      `;

      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: [
              {
                parts: [
                  { text: systemPrompt },
                  {
                    inlineData: {
                      mimeType: 'image/jpeg',
                      data: base64Data,
                    },
                  },
                ],
              },
            ],
            generationConfig: {
              responseMimeType: "application/json"
            }
          }),
        }
      );

      const data = await response.json();
      
      if (!data.candidates || data.candidates.length === 0) {
        throw new Error("패션계가 널 거부했어. 다시 시도해봐.");
      }

      let textResponse = data.candidates[0].content.parts[0].text;
      
      // Clean up markdown code blocks if present (Prevent JSON parse error)
      textResponse = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();

      const parsedResult = JSON.parse(textResponse);

      // Validate and sanitize the data structure (Prevent undefined/map errors)
      const safeResult = {
        score: typeof parsedResult.score === 'number' ? parsedResult.score : 0,
        roast: typeof parsedResult.roast === 'string' ? parsedResult.roast : "할 말이 없네.",
        analysis: {
          fit: parsedResult.analysis?.fit || "평가 불가",
          color: parsedResult.analysis?.color || "평가 불가",
          trend: parsedResult.analysis?.trend || "평가 불가",
        },
        recommendation: Array.isArray(parsedResult.recommendation) 
          ? parsedResult.recommendation 
          : (parsedResult.recommendation ? [String(parsedResult.recommendation)] : ["스타일리스트 고용하기"])
      };
      
      setResult(safeResult);

    } catch (err) {
      console.error(err);
      setError("분석 실패. 옷이 너무 난해해서 AI도 포기했나봐?");
    } finally {
      setLoading(false);
    }
  };

  const reset = () => {
    setImage(null);
    setResult(null);
    setError(null);
  };

  // Helper to safely render text
  const renderText = (text) => {
    if (typeof text === 'object') return JSON.stringify(text);
    return text;
  };

  // --- UI Components ---

  // Loading Screen
  if (loading) {
    return (
      <div className="min-h-screen bg-black flex flex-col items-center justify-center p-6 text-center">
        <div className="animate-spin mb-8 text-[#ccff00]">
          <RefreshCcw size={64} />
        </div>
        <h2 className="text-2xl font-bold text-white mb-2 animate-pulse">
          스캔 중...
        </h2>
        <p className="text-gray-400">
          "어휴, 이걸 입고 나왔다고? <br/>잠깐만, 진정제 좀 찾고..."
        </p>
      </div>
    );
  }

  // Result Screen
  if (result) {
    return (
      <div className="min-h-screen bg-black text-white p-6 pb-20 overflow-y-auto font-sans selection:bg-[#ccff00] selection:text-black">
        <div className="max-w-md mx-auto">
          {/* Header */}
          <div className="flex justify-between items-center mb-8">
            <h1 className="text-[#ccff00] font-bold tracking-tighter text-xl">CHEONGDAM <br/>STYLIST</h1>
            <button onClick={reset} className="bg-[#222] p-2 rounded-full hover:bg-[#333]">
              <RefreshCcw size={20} className="text-white" />
            </button>
          </div>

          {/* Image Preview (Small) */}
          <div className="flex justify-center mb-6">
            <div className="w-24 h-24 rounded-full overflow-hidden border-2 border-[#ccff00] relative">
              <img src={image} alt="User upload" className="w-full h-full object-cover" />
            </div>
          </div>

          {/* Score */}
          <div className="text-center mb-8 relative">
            <p className="text-gray-400 text-sm mb-1 uppercase tracking-widest">Fashion Score</p>
            <h2 className="text-8xl font-black text-transparent bg-clip-text bg-gradient-to-b from-[#ccff00] to-green-800" style={{fontFamily: 'Impact, sans-serif'}}>
              {result.score}
            </h2>
            {result.score < 50 && (
              <div className="absolute top-0 right-10 rotate-12 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded">
                DISASTER
              </div>
            )}
             {result.score >= 80 && (
              <div className="absolute top-0 right-10 -rotate-12 bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded">
                NOT BAD
              </div>
            )}
          </div>

          {/* Roast Quote */}
          <div className="bg-[#111] border border-[#333] p-6 rounded-xl mb-6 relative overflow-hidden">
            <div className="absolute top-0 left-0 w-1 h-full bg-[#ccff00]"></div>
            <Zap className="text-[#ccff00] mb-3" size={24} />
            <p className="text-lg font-bold leading-relaxed text-gray-100">
              "{renderText(result.roast)}"
            </p>
          </div>

          {/* Detailed Analysis */}
          <div className="space-y-4 mb-8">
            <div className="bg-[#0a0a0a] p-4 rounded-lg border border-[#222]">
              <div className="flex items-center gap-2 mb-2 text-[#ccff00]">
                <Scissors size={18} />
                <h3 className="font-bold">FIT CHECK</h3>
              </div>
              <p className="text-sm text-gray-400">{renderText(result.analysis.fit)}</p>
            </div>
            
            <div className="bg-[#0a0a0a] p-4 rounded-lg border border-[#222]">
              <div className="flex items-center gap-2 mb-2 text-[#ff0099]">
                <Shirt size={18} />
                <h3 className="font-bold">COLOR MATCH</h3>
              </div>
              <p className="text-sm text-gray-400">{renderText(result.analysis.color)}</p>
            </div>

            <div className="bg-[#0a0a0a] p-4 rounded-lg border border-[#222]">
              <div className="flex items-center gap-2 mb-2 text-cyan-400">
                <AlertTriangle size={18} />
                <h3 className="font-bold">TREND ALERT</h3>
              </div>
              <p className="text-sm text-gray-400">{renderText(result.analysis.trend)}</p>
            </div>
          </div>

          {/* Solution */}
          <div className="mb-12">
            <h3 className="text-center text-white font-bold mb-4 uppercase tracking-widest text-sm">Emergency Prescription</h3>
            <ul className="bg-[#1a1a1a] rounded-xl divide-y divide-[#333]">
              {result.recommendation && result.recommendation.map((item, idx) => (
                <li key={idx} className="p-4 flex items-center justify-between">
                  <span className="text-gray-200">{renderText(item)}</span>
                  <span className="text-xs bg-[#333] px-2 py-1 rounded text-[#ccff00]">BUY NOW</span>
                </li>
              ))}
            </ul>
          </div>

          <button 
            onClick={reset}
            className="w-full bg-[#ccff00] text-black font-black py-4 rounded-xl text-lg hover:bg-[#b3e600] transition-transform active:scale-95"
          >
            다른 옷으로 욕 더 먹기
          </button>
        </div>
      </div>
    );
  }

  // Main Home Screen
  return (
    <div className="min-h-screen bg-black text-white flex flex-col relative overflow-hidden font-sans">
      {/* Background Elements */}
      <div className="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-[#ccff00] opacity-5 blur-[100px] rounded-full pointer-events-none"></div>
      <div className="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-[#ff0099] opacity-5 blur-[100px] rounded-full pointer-events-none"></div>

      <div className="flex-1 flex flex-col justify-center items-center p-6 text-center z-10">
        <div className="mb-2 px-3 py-1 border border-[#333] rounded-full inline-block">
          <span className="text-xs font-bold text-gray-400 tracking-widest">BETA v0.9</span>
        </div>
        
        <h1 className="text-5xl md:text-6xl font-black mb-2 tracking-tighter leading-none">
          FASHION<br/>
          <span className="text-transparent bg-clip-text bg-gradient-to-r from-[#ccff00] to-[#ff0099]">POLICE</span>
        </h1>
        
        <p className="text-gray-400 mb-12 max-w-xs mx-auto text-sm leading-relaxed">
          청담동 20년차 스타일리스트가 당신의 패션을<br/>
          아주 처참하게 짓밟아 드립니다.
        </p>

        {/* Upload Area */}
        <div className="w-full max-w-sm mx-auto">
          {!image ? (
            <div 
              onClick={triggerUpload}
              className="group cursor-pointer bg-[#111] border-2 border-dashed border-[#333] hover:border-[#ccff00] rounded-2xl p-10 transition-all duration-300 flex flex-col items-center justify-center gap-4"
            >
              <div className="bg-[#222] p-4 rounded-full group-hover:bg-[#ccff00] group-hover:text-black transition-colors">
                <Camera size={32} />
              </div>
              <div>
                <p className="font-bold text-lg">사진 업로드</p>
                <p className="text-xs text-gray-500 mt-1">전신샷 권장 / 갤러리 연동</p>
              </div>
            </div>
          ) : (
            <div className="relative rounded-2xl overflow-hidden border border-[#333]">
              <img src={image} alt="Preview" className="w-full h-auto max-h-[400px] object-cover opacity-50" />
              <div className="absolute inset-0 flex items-center justify-center flex-col bg-black/40 backdrop-blur-sm">
                <button 
                  onClick={analyzeFashion}
                  className="bg-[#ccff00] text-black font-bold px-8 py-3 rounded-full text-lg mb-3 hover:scale-105 transition-transform flex items-center gap-2 shadow-[0_0_20px_rgba(204,255,0,0.4)]"
                >
                  <Zap size={20} fill="black" />
                  팩트 폭격 맞기
                </button>
                <button 
                  onClick={() => setImage(null)}
                  className="text-white text-sm underline hover:text-gray-300"
                >
                  다른 사진 고르기
                </button>
              </div>
            </div>
          )}
          
          <input 
            type="file" 
            ref={fileInputRef} 
            onChange={handleFileChange} 
            accept="image/*" 
            className="hidden" 
          />
        </div>
      </div>
      
      <div className="p-6 text-center z-10">
        <p className="text-[10px] text-gray-600">
          WARNING: 심약자나 패션 테러리스트는<br/>상처받을 수 있으니 주의하세요.
        </p>
      </div>

      {error && (
        <div className="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-full text-sm font-bold shadow-lg z-50">
          {error}
        </div>
      )}
    </div>
  );
};

export default FashionRoaster;